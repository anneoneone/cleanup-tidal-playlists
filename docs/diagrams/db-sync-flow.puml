@startuml db-sync-flow
title Database-Driven Sync Flow

actor User
participant "CLI\n(db sync)" as CLI
participant SyncOrchestrator as Orch
participant TidalStateFetcher as Tidal
participant FilesystemScanner as FS
participant SyncDecisionEngine as Engine
participant DownloadOrchestrator as Download
database "SQLite\nDatabase" as DB

User -> CLI: tidal-cleanup db sync
activate CLI

CLI -> Orch: sync_all()
activate Orch

== Stage 1: Fetch Tidal State ==
Orch -> Tidal: fetch_all_playlists()
activate Tidal
Tidal -> DB: Clear in_tidal flags
Tidal -> "Tidal API": Get playlists
"Tidal API" --> Tidal: playlists
loop For each playlist
    Tidal -> "Tidal API": Get tracks
    "Tidal API" --> Tidal: tracks
    Tidal -> DB: Create/Update tracks
    Tidal -> DB: Mark in_tidal=True
end
Tidal -> DB: Create snapshot
Tidal --> Orch: FetchStatistics
deactivate Tidal

== Stage 2: Scan Filesystem ==
Orch -> FS: scan_all_playlists()
activate FS
FS -> FS: List audio files in\nPlaylists directory
loop For each file
    FS -> DB: Find or create track
    FS -> DB: Add file_path to track
    FS -> DB: Mark in_local=True
end
FS --> Orch: ScanStatistics
deactivate FS

== Stage 3: Analyze Deduplication ==
Orch -> Engine: analyze_deduplication()
activate Engine
Engine -> DB: Get tracks in multiple playlists
Engine --> Orch: DeduplicationResult
deactivate Engine

== Stage 4: Generate Decisions ==
Orch -> Engine: analyze_all_playlists()
activate Engine
loop For each playlist
    Engine -> DB: Get playlist tracks
    Engine -> Engine: Compare in_tidal vs in_local
    alt Track in Tidal, not local
        Engine -> Engine: Decision: DOWNLOAD_TRACK
    else Track local, not in Tidal
        Engine -> Engine: Decision: REMOVE_FILE
    else Track in both
        Engine -> Engine: Decision: NO_ACTION
    end
end
Engine --> Orch: SyncDecisions
deactivate Engine

== Stage 5: Execute Decisions ==
Orch -> Download: execute_decisions(decisions)
activate Download
loop For each decision
    alt DOWNLOAD_TRACK
        Download -> "tidal-dl-ng": Download track
        "tidal-dl-ng" --> Download: file
        Download -> DB: Update track.file_paths
        Download -> DB: Set download_status
    else REMOVE_FILE
        Download -> Download: Check file not needed\nby other playlists
        Download -> FS: Remove file
        Download -> DB: Remove from track.file_paths
    end
end
Download --> Orch: ExecutionResult
deactivate Download

Orch --> CLI: SyncResult
deactivate Orch

CLI -> CLI: Display summary
CLI --> User: Sync complete
deactivate CLI

@enduml
